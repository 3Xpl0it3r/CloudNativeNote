
#### 模型
- 受测模型
&emsp;扰动是干扰测试的结果(定时的系统任务/其他用户活动，尤其在多租户情况下)

- 排队系统
&emsp;排队系统可以预测响应时间在负载情况下是如何退化的(排队系统可以理解为相同的任务，在排队执行，例如磁盘可以模型化为排队系统)



#### 概念 

##### 延时
&emsp;`延时`是操作执行之前所需要等待的时间。`响应时间`: 延时+操作时间
- DNS 延时
>  整个dns的操作时间
- TCP 连接延时
> TCP 初始化的时间(TCP握手)
....
&emsp;延时是一个时间上的指标，不通的指标计算方法不一样



##### 权衡
&emsp; 在计算机世界里面都是权衡的结果，tradeoff
&emsp; `内存`和`CPU`的权衡
- 内存可以换成数据结果，降低CPU的使用率
- CPU可以压缩数据，来降低内存的使用率

&emsp; 文件系统块的大小: 
- 小的块对随机i/o的负载会更友好(因为可以充分的利用文件系统的特性)
- 大的块能提高流的工作性能（例如文件备份系统)

&emsp;网络缓存尺寸
- 小的网络缓存块会减少每个链接的内存开销，有利于系统的扩展
- 大的网络缓存尺寸可以提高网络吞吐量


##### 调优的影响
&emsp;相对于系统层面的调优，应用层面的调优更为显著，但是它的观测效果不一定是最好的.(例如数据库查询缓慢，最好从它所话费的CPU时间，文件系统时间，和所执行的时间来考察).


##### 性能分析时机
&emsp; 当出现下面三种情况，我们就可以考虑停止分析
- 已经能够解释大部分性能问题的时候(某些资源消耗比正常情况下高出很多，我们有理由怀疑这是一个异常的点)
- 当潜在的投资回报低于分析成本的时候
- 当其他地方有更大回报的时候


#### 架构与负载
&emsp; 应用程序的性能可能因为它的配置和硬件问题导致差异，也有可能是太多的负载导致长时间排队和长延时(需要具体分析, 是不是排队系统，需不需要增加机器)


#####  扩展性
&emsp;负载增加下的系统所展现出来的性能问题---扩展性
> 在一定的阶段，可以观测到扩展性是线性变化的，达到某一个点，可能出现对资源的竞争，开始影响性能，过了这个拐点，吞吐曲线会随着资源争夺加剧系统偏离线性，最终导致吞吐下降。
- 当CPU接近100%使用率的时候，CPU调度延迟增加，性能下降
- CPU到100%的时候，吞吐量随着更多的线程增加而下降，更多的上下文切换，消耗CPU资源，导致实际完成的任务变少。

> 当系统开始换页(或者使用了swap的时候)时候导致性能下降
- 快速下降----内存复杂 或者是 IO 负载
- 慢速下降---CPU负载


#### 指标

- 吞吐量: 每秒的数据量或者操作量(取决于上下文环境)
- IOPS： 每秒的IO操作数
- 使用率: 资源繁忙程序，百分比标示
- 延时: 操作时间，以平均数或者百分比表示


##### 使用率
**基于时间的使用率**
&emsp; 服务器或者资源繁忙的均值。 
> 公式: U=B/T (U 是使用率B 是T时间内系统繁忙时间， T是观测周期)

> 这个值只是告诉我们当前系统繁忙程度，但是至于它是不是成为系统瓶颈需要观测.
> 100%运行的电梯，它仍然可以搭载乘客

**基于容量的使用率**
> 100%容量的电梯无法搭载更多的乘客

&emsp; 100%的忙碌不意味着100%的容量使用

##### 饱和度
&emsp; 随着工作的增加对资源的请求超过资源所能处理的程度----饱和度

> 使用率100% 可能不是性能问题的瓶颈，但是任何程度的饱和度都是性能问题。


##### 缓存
&emsp;性能另外一个重要的指标---缓存命中率
> 命中率 = 命中次数 / （命中次数 + 失效次数)

&emsp; 缓存性能的另外一个指标--缓存失效率(每秒缓存失效的次数)

**工作负载总的运行时间**
> 运行时间 = (命中率 * 命中延时) + (市销率 * 失效延时)



&emsp;缓存策略
- MRU(最近最常使用) --- 决定什么样的数据可以留在缓存里面
- LRU(最近最少使用) --- 是一种回收策略
- MFU(最常使用)和LFU(最不常使用)


&emsp;缓存的热/冷/温
- 冷: 缓存是空的
- 热: 热缓存里面填充的都是常用的数据，并且有着很高的命中率
- 温: 填充了有用的数据，但是命中率没有想象中那么高



#### 性能分析视角
&emsp;性能分析一般有两个角度: *工作负载分析*和*资源分析*,  不同的视角受众，指标和方法都不一样，这两个视角可以分别对应为系统软件站自上而下和自底而上的方法.

##### 资源分析
&emsp;资源分析以系统资源的分析为起点: cpu,内存,磁盘,网卡,总线以及他们之间的互联. 分析的指标如下:
- IOPS 
- 吞吐量
- 使用率
- 饱和度

##### 工作负载分析
&emsp; 工作复杂分析检查应用程序的性能， 分析对象如下:
- 请求: 所是施加的工作负载
- 延时: 应用程序的响应施加
- 完成度: 查找错误(例如日志，错误状态码等)



#### 方法
##### USE 方法(Utilization, saturation, errors)
&emsp; 就是对所有的资源查看它的使用率，饱和度，和错误
- 资源: 所有服务器的物理元件(cpu,总线...)某些软件资源也可以被计算在里面，资源提供有用的指标
- 使用率: 在规定的时间内，资源用于服务工作的时间百分比.但是资源还有能力接收更多的工作(不能接收工作被称为饱和度)
- 饱和度: 资源不能接受再多额外的工作的程度，通常有等待队列--也被称为压力 

> USE方法主要帮助我们得到一张完整的问题列表


**过程**
&emsp;USE方法 首先检查错误，其次检查饱和度(任何级别的饱和度是可能是问题)

**指标描述**
- 使用率: 一定时间内的百分比(例如CPU运行在90%的使用率以上)
- 饱和度: 等待队列的上次(例如cpu的平均队列长度是4等等)
- 错误: 错误数 


**资源列表**
&emsp;通常资源如下:
- cpu: 插槽，核，硬件线程(虚拟CPU)
- 内存: DRAM
- 网络接口: 以太网口，无限带宽技术
- 存储设备: 硬盘，存储适配器
- 加速器: GPU,TPUm FPGA等
- 控制器: 存储，网络
- 互联: CPU,内存，io

**指标**
- cpu使用率: cpu 使用率(单CPU使用率或者系统级均值)
- cpu饱和度: 运行队列的长度, 调度器延时，CPU压力(LinuxPSI)
- cpu错误: 机器异常检查，CPU缓存错误
- 内存使用率:  系统级别的空闲内存
- 内存饱和度: 交换(匿名分页),页面扫描,内存缺失事件,内存压力(PSI)
- 内存错误: 失败的malloc(默认的Linux内核配置因为过度提交会导致这种错误，但是很少发生)
- 网络接口使用率: 接收的吞吐量/最大带宽, 发生吞吐量/最大带宽
- 网络接口饱和度: 与饱和度相关的网络接口或者操作系统错误(例如linux漫溢overrun)
- 存储设备I/O使用率: 设备繁忙百分比
- 存储设备I/O 饱和度: 等待队列长度， I/O 压力(Linux PSI)
- 存储设备I/O 错误:  设备错误（硬错误，软错误)
- cpu互联: 使用率: 每个端口的吞吐量/最大带宽(CPU 性能计数器)
- 内存互联 饱和度: 内存停滞周期数,偏高的平均指令周期(cpu 性能计数器)
- I/O 互联： 使用率:  总线吞吐量/最大带宽（可能在硬件上有性能计数器，例如Intel的非核心事件)
